{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Excuse Requests{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/manage_excuses.css' %}">
{% endblock %}

{% block content %}
<div class="manage-excuses-container">
    <a href="{% url 'teacher_current_classes' %}" class="back-link">â† Quay láº¡i</a>
    
    <div class="excuse-header">
        <h1>ğŸ“‹ Quáº£n lÃ½ Ä‘Æ¡n xin phÃ©p</h1>
        <p style="color: #666; margin-top: 10px;">
            <strong>GiÃ¡o viÃªn:</strong> {{ teacher.teacher_full_name }}
        </p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('pending')">
            â³ Chá» duyá»‡t
            {% if pending_count > 0 %}
            <span class="pending-badge">{{ pending_count }}</span>
            {% endif %}
        </div>
        <div class="tab" onclick="switchTab('approved')">
            âœ… ÄÃ£ duyá»‡t
        </div>
    </div>

    <!-- Pending Requests Tab -->
    <div class="tab-content active" id="pending-tab">
        {% if pending_requests %}
            {% for request in pending_requests %}
            <div class="request-card">
                <div class="request-header">
                    <div class="student-info">
                        <div class="student-name">{{ request.student.student_full_name }}</div>
                        <div class="student-class">Lá»›p {{ request.student.student_class.class_name }}</div>
                    </div>
                    <div class="request-dates">
                        {{ request.start_date|date:"d/m/Y" }} - {{ request.end_date|date:"d/m/Y" }}
                    </div>
                </div>
                
                <div class="request-type">
                    {{ request.get_absence_type_display }}
                    {% if request.specific_periods %}
                    - Tiáº¿t: {{ request.specific_periods }}
                    {% endif %}
                </div>
                
                <div class="request-details">
                    <div class="detail-row">
                        <div class="detail-label">ğŸ“… Sá»‘ ngÃ y:</div>
                        <div class="detail-value">
                            {{ request.start_date|timesince:request.end_date }}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ğŸ“ LiÃªn há»‡:</div>
                        <div class="detail-value">{{ request.parent_contact_method|default:"Gá»­i qua há»‡ thá»‘ng" }}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ğŸ• Gá»­i lÃºc:</div>
                        <div class="detail-value">{{ request.created_at|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                
                <div class="request-reason">
                    <strong>LÃ½ do:</strong><br>
                    {{ request.reason }}
                </div>
                
                <div class="request-actions">
                    <button class="btn btn-approve" onclick="approveRequest('{{ request.excuse_id }}', '{{ request.student.student_full_name }}')">
                        âœ… PhÃª duyá»‡t
                    </button>
                    <button class="btn btn-reject" onclick="rejectRequest('{{ request.excuse_id }}', '{{ request.student.student_full_name }}')">
                        âŒ Tá»« chá»‘i
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">âœ…</div>
                <h3>KhÃ´ng cÃ³ Ä‘Æ¡n chá» duyá»‡t</h3>
                <p>Táº¥t cáº£ Ä‘Æ¡n xin phÃ©p Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½</p>
            </div>
        {% endif %}
    </div>

    <!-- Approved Requests Tab -->
    <div class="tab-content" id="approved-tab">
        {% if approved_requests %}
            {% for request in approved_requests %}
            <div class="request-card approved">
                <div class="request-header">
                    <div class="student-info">
                        <div class="student-name">{{ request.student.student_full_name }}</div>
                        <div class="student-class">Lá»›p {{ request.student.student_class.class_name }}</div>
                    </div>
                    <div class="request-dates">
                        {{ request.start_date|date:"d/m/Y" }} - {{ request.end_date|date:"d/m/Y" }}
                    </div>
                </div>
                
                <div class="approved-status">âœ… ÄÃ£ phÃª duyá»‡t</div>
                <div class="approved-info">
                    Duyá»‡t lÃºc: {{ request.approved_at|date:"d/m/Y H:i" }}
                </div>
                
                <div class="request-type" style="margin-top: 10px;">
                    {{ request.get_absence_type_display }}
                    {% if request.specific_periods %}
                    - Tiáº¿t: {{ request.specific_periods }}
                    {% endif %}
                </div>
                
                <div class="request-reason">
                    <strong>LÃ½ do:</strong><br>
                    {{ request.reason }}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ”­</div>
                <h3>ChÆ°a cÃ³ Ä‘Æ¡n Ä‘Ã£ duyá»‡t</h3>
                <p>CÃ¡c Ä‘Æ¡n Ä‘Ã£ phÃª duyá»‡t sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function switchTab(tab) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tab + '-tab').classList.add('active');
        event.target.classList.add('active');
    }

    function approveRequest(excuseId, studentName) {
        if (!confirm(`PhÃª duyá»‡t Ä‘Æ¡n xin phÃ©p cá»§a ${studentName}?`)) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        showLoading();
        
        fetch(`/teacher/excuse/${excuseId}/approve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Lá»—i: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('CÃ³ lá»—i xáº£y ra', 'error');
        });
    }

    function rejectRequest(excuseId, studentName) {
        const reason = prompt(`LÃ½ do tá»« chá»‘i Ä‘Æ¡n cá»§a ${studentName}:`, 'KhÃ´ng Ä‘á»§ Ä‘iá»u kiá»‡n');
        
        if (!reason) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        showLoading();
        
        fetch(`/teacher/excuse/${excuseId}/reject/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Lá»—i: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('CÃ³ lá»—i xáº£y ra', 'error');
        });
    }
</script>
{% endblock %}