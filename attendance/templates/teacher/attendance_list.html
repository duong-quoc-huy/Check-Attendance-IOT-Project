{% extends 'base.html' %}

{% block title %}Attendance List{% endblock %}

{% block extra_css %}
<style>
    .action-buttons {
        display: flex;
        gap: 0.25rem;
    }
    .status-badge {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>Today's Attendance</h2>
                <p class="text-muted">{{ today|date:"l, F d, Y" }}</p>
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

{% if no_class %}
<div class="alert alert-warning">
    You are not assigned to any class yet.
</div>
{% else %}

<!-- Summary Stats -->
<div class="row mt-3">
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ student_attendance|length }}</h3>
                <p class="mb-0">Total Students</p>
            </div>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0">Student Attendance List</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Student Name</th>
                        <th>Class</th>
                        <th>Card UID</th>
                        <th>Check-in Time</th>
                        <th>Status</th>
                        <th>Verified</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in student_attendance %}
                    <tr id="row-{{ item.student.student_id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <strong>{{ item.student.student_full_name }}</strong>
                        </td>
                        <td>{{ item.student.student_class.class_name }}</td>
                        <td><code>{{ item.student.student_card_uid }}</code></td>
                        <td>
                            {% if item.check_in_time %}
                                {{ item.check_in_time|time:"H:i:s" }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge status-badge 
                                {% if item.status == 'attended' %}bg-success
                                {% elif item.status == 'late' %}bg-warning
                                {% else %}bg-danger{% endif %}"
                                onclick="changeStatus('{{ item.student.student_id }}', '{{ item.status }}')">
                                {% if item.status == 'attended' %}
                                    <i class="bi bi-check-circle"></i> Present
                                {% elif item.status == 'late' %}
                                    <i class="bi bi-clock"></i> Late
                                {% else %}
                                    <i class="bi bi-x-circle"></i> Absent
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if item.attendance %}
                                {% if item.attendance.is_verified_by_teacher %}
                                    <i class="bi bi-check-circle-fill text-success" title="Verified"></i>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="verifyAttendance('{{ item.attendance.attendance_id }}')">
                                        <i class="bi bi-check"></i> Verify
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <!-- Mark Present -->
                                <button class="btn btn-sm btn-success" 
                                        onclick="markAttendance('{{ item.student.student_id }}', 'attended')"
                                        title="Mark Present">
                                    <i class="bi bi-check"></i>
                                </button>
                                
                                <!-- Mark Late -->
                                <button class="btn btn-sm btn-warning" 
                                        onclick="markAttendance('{{ item.student.student_id }}', 'late')"
                                        title="Mark Late">
                                    <i class="bi bi-clock"></i>
                                </button>
                                
                                <!-- Mark Absent -->
                                <button class="btn btn-sm btn-danger" 
                                        onclick="markAttendance('{{ item.student.student_id }}', 'absent')"
                                        title="Mark Absent">
                                    <i class="bi bi-x"></i>
                                </button>
                                
                                <!-- Add Note -->
                                {% if item.attendance %}
                                <button class="btn btn-sm btn-info" 
                                        onclick="addNote('{{ item.attendance.attendance_id }}')"
                                        title="Add Note">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endif %}

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="noteText" rows="4" 
                          placeholder="Enter note here..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">Save Note</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentAttendanceId = null;

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Mark attendance with spinner and toast
    function markAttendance(studentId, status) {
        const statusText = status === 'attended' ? 'present' : status === 'late' ? 'late' : 'absent';
        
        if (!confirm(`Mark student as ${statusText}?`)) return;
        
        showLoading();
        
        fetch(`/teacher/mark-attendance/${studentId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `status=${status}`
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(data.error || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error occurred', 'error');
        });
    }

    // Verify attendance
    function verifyAttendance(attendanceId) {
        showLoading();
        
        fetch(`/teacher/verify-attendance/${attendanceId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(data.error || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error occurred', 'error');
        });
    }

    // Open note modal
    function addNote(attendanceId) {
        currentAttendanceId = attendanceId;
        document.getElementById('noteText').value = '';
        const modal = new bootstrap.Modal(document.getElementById('noteModal'));
        modal.show();
    }

    // Save note
    function saveNote() {
        const note = document.getElementById('noteText').value;
        
        if (!note.trim()) {
            showToast('Please enter a note', 'warning');
            return;
        }
        
        showLoading();
        
        fetch(`/teacher/add-note/${currentAttendanceId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `note=${encodeURIComponent(note)}`
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            } else {
                showToast(data.error || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error occurred', 'error');
        });
    }

    // Change status by clicking badge
    function changeStatus(studentId, currentStatus) {
        const statuses = ['attended', 'late', 'absent'];
        const currentIndex = statuses.indexOf(currentStatus);
        const nextStatus = statuses[(currentIndex + 1) % 3];
        
        markAttendance(studentId, nextStatus);
    }
</script>
{% endblock %}