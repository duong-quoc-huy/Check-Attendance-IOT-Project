{% extends 'base.html' %}
{% load static %}

{% block title %}Request Excuse - {{ student.student_full_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/request_excuse.css' %}">
{% endblock %}

{% block content %}
<div class="request-excuse-container">
    <div class="excuse-header">
        <h1>üìù Xin ph√©p ngh·ªâ h·ªçc</h1>
        <p style="color: #666; margin-top: 10px;">
            <strong>H·ªçc sinh:</strong> {{ student.student_full_name }} | 
            <strong>L·ªõp:</strong> {{ student.student_class.class_name }}
        </p>
    </div>

    <!-- Messages -->
    {% if success %}
    <div class="alert alert-success">
        <span style="font-size: 24px;">‚úÖ</span>
        <span>{{ success }}</span>
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        <span style="font-size: 24px;">‚ùå</span>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    <!-- Request Form -->
    <div class="card">
        <h2 class="card-title">G·ª≠i ƒë∆°n xin ph√©p ngh·ªâ h·ªçc</h2>
        
        <form method="POST" id="excuseForm">
            {% csrf_token %}
            
            <div class="form-row">
                <div class="form-group">
                    <label>T·ª´ ng√†y <span class="required">*</span></label>
                    <input type="date" name="start_date" required min="{{ today|date:'Y-m-d' }}">
                    <div class="help-text">Ng√†y b·∫Øt ƒë·∫ßu ngh·ªâ</div>
                </div>
                
                <div class="form-group">
                    <label>ƒê·∫øn ng√†y <span class="required">*</span></label>
                    <input type="date" name="end_date" required min="{{ today|date:'Y-m-d' }}">
                    <div class="help-text">Ng√†y k·∫øt th√∫c ngh·ªâ</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Lo·∫°i ngh·ªâ <span class="required">*</span></label>
                <select name="absence_type" id="absenceType" required onchange="togglePeriodSelector()">
                    <option value="">-- Ch·ªçn lo·∫°i ngh·ªâ --</option>
                    <option value="full_day">C·∫£ ng√†y</option>
                    <option value="morning">Ch·ªâ bu·ªïi s√°ng</option>
                    <option value="afternoon">Ch·ªâ bu·ªïi chi·ªÅu</option>
                    <option value="specific_periods">C√°c ti·∫øt c·ª• th·ªÉ</option>
                </select>
            </div>
            
            <!-- Period Selector (hidden by default) -->
            <div class="period-selector" id="periodSelector">
                <label style="margin-bottom: 10px; display: block;">Ch·ªçn c√°c ti·∫øt ngh·ªâ:</label>
                <div class="period-checkboxes">
                    {% for i in "12345678" %}
                    <div class="period-checkbox">
                        <input type="checkbox" name="period" value="{{ i }}" id="p{{ i }}">
                        <label for="p{{ i }}">Ti·∫øt {{ i }}</label>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="specific_periods" id="specificPeriods">
            </div>
            
            <div class="form-group">
                <label>L√Ω do <span class="required">*</span></label>
                <textarea name="reason" required placeholder="Vui l√≤ng n√™u r√µ l√Ω do xin ph√©p (t·ªëi thi·ªÉu 10 k√Ω t·ª±)..."></textarea>
                <div class="help-text">V√≠ d·ª•: ƒêi kh√°m b√°c sƒ©, c√≥ vi·ªác gia ƒë√¨nh...</div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">üì§ G·ª≠i ƒë∆°n xin ph√©p</button>
                <button type="reset" class="btn btn-secondary">üîÑ Nh·∫≠p l·∫°i</button>
            </div>
        </form>
    </div>

    <!-- Recent Requests -->
    <div class="card">
        <h2 class="card-title">ƒê∆°n xin ph√©p g·∫ßn ƒë√¢y</h2>
        
        {% if excuse_requests %}
            <div class="requests-list">
                {% for request in excuse_requests %}
                <div class="request-item {% if request.approved_by_homeroom %}approved{% else %}pending{% endif %}">
                    <div class="request-header">
                        <div class="request-dates">
                            üìÖ {{ request.start_date|date:"d/m/Y" }} - {{ request.end_date|date:"d/m/Y" }}
                        </div>
                        <div class="request-status {% if request.approved_by_homeroom %}approved{% else %}pending{% endif %}">
                            {% if request.approved_by_homeroom %}
                                ‚úÖ ƒê√£ duy·ªát
                            {% else %}
                                ‚è≥ Ch·ªù duy·ªát
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="request-type">
                        {{ request.get_absence_type_display }}
                        {% if request.specific_periods %}
                        - Ti·∫øt: {{ request.specific_periods }}
                        {% endif %}
                    </div>
                    
                    <div class="request-reason">
                        <strong>L√Ω do:</strong> {{ request.reason }}
                    </div>
                    
                    <div class="request-meta">
                        G·ª≠i l√∫c: {{ request.created_at|date:"d/m/Y H:i" }}
                        {% if request.approved_at %}
                        | Duy·ªát l√∫c: {{ request.approved_at|date:"d/m/Y H:i" }}
                        {% endif %}
                    </div>
                    
                    {% if not request.approved_by_homeroom %}
                    <div class="request-actions">
                        <button class="btn-cancel" onclick="cancelRequest('{{ request.excuse_id }}')">
                            üóëÔ∏è H·ªßy ƒë∆°n
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üî≠</div>
                <h3>Ch∆∞a c√≥ ƒë∆°n xin ph√©p n√†o</h3>
                <p>ƒêi·ªÅn form b√™n tr√™n ƒë·ªÉ g·ª≠i ƒë∆°n xin ph√©p</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function togglePeriodSelector() {
        const absenceType = document.getElementById('absenceType').value;
        const periodSelector = document.getElementById('periodSelector');
        
        if (absenceType === 'specific_periods') {
            periodSelector.classList.add('active');
        } else {
            periodSelector.classList.remove('active');
        }
    }

    // Handle form submission for specific periods
    document.getElementById('excuseForm').addEventListener('submit', function(e) {
        const absenceType = document.getElementById('absenceType').value;
        
        if (absenceType === 'specific_periods') {
            const checkboxes = document.querySelectorAll('input[name="period"]:checked');
            const periods = Array.from(checkboxes).map(cb => cb.value);
            
            if (periods.length === 0) {
                e.preventDefault();
                showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ti·∫øt h·ªçc', 'warning');
                return;
            }
            
            document.getElementById('specificPeriods').value = periods.join(',');
        }
    });

    function cancelRequest(excuseId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n xin ph√©p n√†y?')) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        showLoading();
        
        fetch(`/parent/excuse/${excuseId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('L·ªói: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('C√≥ l·ªói x·∫£y ra', 'error');
        });
    }
</script>
{% endblock %}